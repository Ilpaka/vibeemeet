# Логика базы данных системы видеоконференций

## Обзор архитектуры

База данных спроектирована для поддержки полнофункциональной системы видеоконференций с использованием LiveKit в качестве медиа-сервера. Архитектура следует принципам нормализации и обеспечивает целостность данных через внешние ключи и ограничения.

## Основные сущности и их взаимосвязи

### 1. Пользователи (users)

**Назначение:** Хранение информации о пользователях системы.

**Ключевые поля:**
- `id` (UUID) - уникальный идентификатор пользователя
- `email` (CITEXT) - email пользователя (case-insensitive, уникальный)
- `password_hash` (TEXT) - хеш пароля (bcrypt)
- `display_name` (TEXT) - отображаемое имя
- `global_role` - глобальная роль: `user` или `technical_admin`
- `is_active` - флаг активности аккаунта
- `is_email_verified` - флаг подтверждения email

**Аргументация:**
- Использование CITEXT для email обеспечивает case-insensitive сравнение
- UUID вместо SERIAL для безопасности (нельзя угадать ID)
- Отдельное поле `password_hash` для безопасности (никогда не храним пароли в открытом виде)
- Флаг `is_active` позволяет деактивировать аккаунты без удаления данных
- Флаг `is_email_verified` необходим для будущей функциональности верификации

**Индексы:**
- `idx_users_email` - быстрый поиск по email при авторизации
- `idx_users_created_at` - для аналитики и сортировки
- `idx_users_global_role` - для фильтрации по ролям

### 2. Сессии пользователей (user_sessions)

**Назначение:** Управление refresh tokens для JWT авторизации.

**Ключевые поля:**
- `refresh_token_hash` - SHA-256 хеш refresh token (не храним сам токен)
- `expires_at` - время истечения сессии
- `revoked_at` - время отзыва сессии
- `ip_address`, `user_agent` - для безопасности и аналитики

**Аргументация:**
- Хранение хеша токена вместо самого токена повышает безопасность
- Поле `revoked_at` позволяет отзывать токены до истечения срока
- Информация об IP и User-Agent помогает отслеживать подозрительную активность
- Каскадное удаление при удалении пользователя (ON DELETE CASCADE)

**Индексы:**
- `idx_user_sessions_user_id` - поиск всех сессий пользователя
- `idx_user_sessions_expires_at` - очистка истекших сессий
- `idx_user_sessions_token_hash` - быстрая валидация токена

### 3. Комнаты (rooms)

**Назначение:** Управление комнатами видеоконференций.

**Ключевые поля:**
- `livekit_room_name` - имя комнаты в LiveKit (уникальное)
- `host_user_id` - создатель/хост комнаты
- `status` - статус: `scheduled`, `active`, `ended`, `cancelled`
- `waiting_room_enabled` - включена ли комната ожидания
- `is_locked` - заблокирована ли комната
- `password_hash` - хеш пароля комнаты (если требуется)
- `settings` (JSONB) - дополнительные настройки комнаты

**Аргументация:**
- Отдельное поле `livekit_room_name` для связи с LiveKit сервером
- Статусы комнаты позволяют отслеживать жизненный цикл конференции
- JSONB поле `settings` для гибкости (можно добавить любые настройки без миграций)
- Поля `scheduled_start_at` и `scheduled_end_at` для планирования конференций
- Поля `actual_start_at` и `actual_end_at` для статистики

**Индексы:**
- `idx_rooms_host` - поиск комнат по хосту
- `idx_rooms_status` - фильтрация по статусу
- `idx_rooms_scheduled_start` - поиск запланированных конференций
- `idx_rooms_livekit_name` - быстрый поиск по имени LiveKit комнаты

### 4. Участники комнат (room_participants)

**Назначение:** Отслеживание участников в каждой комнате.

**Ключевые поля:**
- `role` - роль: `host`, `co_host`, `participant`
- `livekit_sid` - Session ID в LiveKit (уникальный)
- `joined_at` / `left_at` - время входа/выхода
- `is_kicked` - был ли участник исключен
- `initial_muted` - был ли участник изначально заглушен

**Аргументация:**
- Связь с `user_id` может быть NULL для гостей (незарегистрированных пользователей)
- Поле `livekit_sid` необходимо для синхронизации с LiveKit
- Отслеживание времени входа/выхода для статистики и биллинга
- Флаг `is_kicked` позволяет различать добровольный выход и исключение
- Поле `leave_reason` для аналитики причин выхода

**Индексы:**
- `idx_rp_room_id_joined_at` - список участников комнаты с сортировкой
- `idx_rp_user_id` - все комнаты пользователя
- `idx_rp_livekit_sid` - быстрый поиск по LiveKit SID
- `idx_rp_left_at` (partial) - только активные участники (WHERE left_at IS NULL)

### 5. Waiting Room (waiting_room_entries)

**Назначение:** Управление очередью ожидания для комнат с включенной функцией waiting room.

**Ключевые поля:**
- `status` - статус: `pending`, `approved`, `rejected`, `expired`
- `requested_at` - время запроса на вход
- `decided_at` - время принятия решения
- `decided_by_user_id` - кто принял решение (хост/ко-хост)

**Аргументация:**
- Позволяет хосту контролировать, кто может присоединиться к конференции
- Статус `expired` для автоматической очистки старых запросов
- Поле `reason` для объяснения отклонения запроса
- Отслеживание, кто принял решение, для аудита

**Индексы:**
- `idx_wre_room_status` - быстрый поиск запросов по комнате и статусу
- `idx_wre_user` - все запросы пользователя
- `idx_wre_requested_at` - сортировка по времени запроса

### 6. Сообщения чата (chat_messages)

**Назначение:** Хранение сообщений чата в комнатах.

**Ключевые поля:**
- `sender_participant_id` - ссылка на участника (не на пользователя напрямую)
- `message_type` - тип: `user` или `system`
- `content` - текст сообщения
- `edited_at` / `deleted_at` - для поддержки редактирования и удаления
- `deleted_by_participant_id` - кто удалил сообщение

**Аргументация:**
- Связь через `room_participants`, а не напрямую с `users`, чтобы поддерживать гостей
- Мягкое удаление (`deleted_at`) для возможности восстановления и аудита
- Поле `edited_at` для отслеживания редактированных сообщений
- Системные сообщения (`message_type='system'`) для автоматических уведомлений

**Индексы:**
- `idx_chat_room_created_at` - сообщения комнаты с сортировкой по времени
- `idx_chat_sender` - все сообщения участника
- `idx_chat_deleted` (partial) - только неудаленные сообщения

### 7. Статистика участников (participant_stats)

**Назначение:** Сбор метрик качества соединения для каждого участника.

**Ключевые поля:**
- Метрики сети: RTT, jitter, packet loss, bitrate
- `network_score` - общая оценка качества (0-100)

**Аргументация:**
- Позволяет отслеживать проблемы с качеством соединения
- Метрики помогают в диагностике проблем
- `network_score` для быстрой оценки качества
- Одна запись на участника (UNIQUE constraint)

**Индексы:**
- `idx_ps_network_score` - поиск участников с плохим соединением
- `idx_ps_created_at` - временная сортировка

### 8. Настройки пользователей (user_settings)

**Назначение:** Персональные настройки пользователей.

**Ключевые поля:**
- Устройства по умолчанию (камера, микрофон, динамики)
- `preferred_video_quality` - предпочитаемое качество видео
- `preferred_theme` - тема интерфейса
- `mute_mic_on_join` / `disable_camera_on_join` - настройки при входе

**Аргументация:**
- Отдельная таблица для нормализации (1:1 с users)
- Позволяет хранить настройки без изменения основной таблицы users
- JSONB не используется здесь, так как структура известна заранее

### 9. Видеопрофили пользователей (user_video_profiles)

**Назначение:** Профили видео с настройками фона и фильтров.

**Ключевые поля:**
- `background_type` - тип фона: `none`, `blur`, `image`
- `background_image_url` - URL изображения фона
- `noise_suppression_level` - уровень подавления шума
- `is_default` - профиль по умолчанию

**Аргументация:**
- Позволяет пользователям создавать несколько профилей
- Флаг `is_default` для автоматического применения профиля
- Поддержка различных типов фонов для гибкости

**Индексы:**
- `idx_uvp_user` - все профили пользователя
- `idx_uvp_default` - быстрый поиск профиля по умолчанию

### 10. Аудит-логи (audit_log)

**Назначение:** Логирование всех важных действий в системе.

**Ключевые поля:**
- `actor_user_id` / `actor_role` - кто выполнил действие
- `room_id` - в какой комнате (если применимо)
- `event_type` - тип события
- `payload` (JSONB) - дополнительные данные события

**Аргументация:**
- Неизменяемый лог всех действий для безопасности и отладки
- JSONB для гибкости (можно логировать любые данные)
- Поле `actor_role` для случаев, когда действие выполняется системой
- Индексы по времени для быстрого поиска по периодам

**Индексы:**
- `idx_audit_room_time` - события в комнате по времени
- `idx_audit_actor_time` - события пользователя по времени
- `idx_audit_event_type` - фильтрация по типу события

## Приглашения в комнаты (room_invites)

**Назначение:** Управление пригласительными ссылками для комнат.

**Ключевые поля:**
- `link_token` - уникальный токен для ссылки
- `expires_at` - срок действия ссылки
- `max_uses` - максимальное количество использований
- `used_count` - текущее количество использований

**Аргументация:**
- Позволяет создавать временные и ограниченные ссылки
- Отслеживание использования для безопасности
- Возможность создания нескольких ссылок для одной комнаты с разными правами

**Индексы:**
- `idx_room_invites_room_id` - все приглашения комнаты
- `idx_room_invites_token` - быстрая валидация токена
- `idx_room_invites_expires` - очистка истекших приглашений

## Триггеры и функции

### update_updated_at_column()

Автоматически обновляет поле `updated_at` при изменении записи. Применяется к таблицам:
- `users`
- `rooms`
- `user_settings`

**Аргументация:** Обеспечивает актуальность времени последнего обновления без необходимости ручного обновления в коде.

## Тестовые данные

В файле `init_db.sql` создаются тестовые пользователи:
- 5 обычных пользователей (ilya@example.com, ivan@example.com, и т.д.)
- 1 администратор (admin@example.com)
- Пароль для всех: `password123` (для обычных) и `admin123` (для админа)

**Аргументация:** Тестовые данные позволяют сразу начать работу с системой без необходимости регистрации.

## Рекомендации по использованию

1. **Миграции:** Используйте систему миграций для изменений схемы БД
2. **Бэкапы:** Регулярно создавайте бэкапы, особенно таблицы `users`, `rooms`, `chat_messages`
3. **Очистка:** Настройте периодическую очистку:
   - Истекших сессий (`user_sessions`)
   - Старых аудит-логов (`audit_log`)
   - Завершенных комнат (`rooms` со статусом `ended`)
4. **Мониторинг:** Отслеживайте:
   - Размер таблиц (особенно `chat_messages` и `audit_log`)
   - Производительность индексов
   - Количество активных сессий

## Безопасность

1. **Пароли:** Всегда используйте bcrypt для хеширования паролей
2. **Токены:** Храните только хеши refresh tokens, никогда сами токены
3. **SQL Injection:** Используйте параметризованные запросы (поддерживается pgx)
4. **Доступ:** Ограничьте доступ к БД только для backend приложения
5. **SSL:** Используйте SSL соединения в production (`sslmode=require`)

