# 🎯 VibeMeet User Flow - Новая Архитектура

## 📋 Обзор

VibeMeet теперь интегрирован с централизованным Auth-сервисом. Создание комнат доступно только зарегистрированным пользователям, но присоединение к комнатам возможно для всех по ссылке-приглашению.

---

## 🔄 User Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    index.html (Главная)                      │
│                                                               │
│  ┌─────────────┐              ┌─────────────┐               │
│  │   Войти     │              │ Регистрация │               │
│  └──────┬──────┘              └──────┬──────┘               │
└─────────┼──────────────────────────────┼────────────────────┘
          │                              │
          └──────────────┬───────────────┘
                         │
                         ▼
          ┌──────────────────────────────┐
          │       Auth.html              │
          │  ┌────────────────────────┐  │
          │  │  Вход  │  Регистрация  │  │
          │  └────────────────────────┘  │
          │                              │
          │  Auth-сервис (localhost:8080)│
          └──────────────┬───────────────┘
                         │
                         ▼
          ┌──────────────────────────────┐
          │      Dashboard.html          │
          │                              │
          │  Привет, [Имя]!     [Выйти] │
          │                              │
          │  ┌────────────────────────┐  │
          │  │  Создать комнату       │  │
          │  └────────────────────────┘  │
          │  ┌────────────────────────┐  │
          │  │  Войти по ID           │  │
          │  └────────────────────────┘  │
          └──────────────┬───────────────┘
                         │
                         ▼
          ┌──────────────────────────────┐
          │         room.html            │
          │                              │
          │  Видеоконференция            │
          │  (LiveKit + VibeMeet API)    │
          └──────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Гостевой доступ (без регистрации)               │
│                                                               │
│  Ссылка-приглашение → room.html?room=UUID                   │
│                           ↓                                   │
│                   Ввод имени (Guest)                         │
│                           ↓                                   │
│              Присоединение к комнате                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 Сценарии использования

### 1️⃣ Новый пользователь - Регистрация

1. Пользователь открывает `http://localhost` (index.html)
2. Нажимает **"Регистрация"**
3. Переходит на `Auth.html#register`
4. Заполняет форму:
   - Имя
   - Email
   - Пароль (минимум 8 символов)
   - Подтверждение пароля
5. Нажимает **"Зарегистрироваться"**
6. Auth-сервис создает пользователя и возвращает JWT токены
7. Автоматический редирект на `Dashboard.html`

**Технические детали:**
- POST `http://localhost:8080/auth/register`
- Токены сохраняются в `localStorage`:
  - `accessToken` (JWT, 15 минут)
  - `refreshToken` (7 дней)
  - `user` (JSON с данными пользователя)

---

### 2️⃣ Существующий пользователь - Вход

1. Пользователь открывает `http://localhost` (index.html)
2. Нажимает **"Войти"**
3. Переходит на `Auth.html`
4. Заполняет форму:
   - Email
   - Пароль
5. Нажимает **"Войти"**
6. Auth-сервис проверяет credentials и возвращает JWT токены
7. Автоматический редирект на `Dashboard.html`

**Технические детали:**
- POST `http://localhost:8080/auth/login`
- Токены сохраняются в `localStorage`

---

### 3️⃣ Создание комнаты (только для авторизованных)

1. Пользователь на `Dashboard.html`
2. Нажимает **"Создать комнату"**
3. VibeMeet API создает комнату с JWT токеном:
   ```json
   POST http://localhost:8081/api/v1/rooms
   Headers: {
     "Authorization": "Bearer <accessToken>"
   }
   Body: {
     "title": "Комната [Имя]",
     "description": "Новая видеоконференция",
     "max_participants": 10
   }
   ```
4. Получает `room_id` и `livekit_token`
5. Автоматический редирект на `room.html?room=<room_id>`

**Важно:**
- Только зарегистрированные пользователи могут создавать комнаты
- `host_user_id` в таблице `rooms` = `user_id` из Auth-сервиса
- Создатель комнаты = хост

---

### 4️⃣ Присоединение к комнате по ID (для авторизованных)

1. Пользователь на `Dashboard.html`
2. Нажимает **"Войти по ID"**
3. Вводит UUID комнаты
4. Нажимает **"Присоединиться"**
5. Переход на `room.html?room=<room_id>`

---

### 5️⃣ Гостевой доступ (без регистрации) 🎉

1. Хост создает комнату и получает ссылку-приглашение:
   ```
   http://localhost/room.html?room=<room_id>
   ```
2. Хост отправляет ссылку гостю (email, мессенджер, и т.д.)
3. Гость переходит по ссылке
4. Система показывает модальное окно: "Введите ваше имя"
5. Гость вводит имя (например, "Иван Гость")
6. VibeMeet создает временную гостевую сессию:
   ```json
   POST http://localhost:8080/auth/guest
   Body: {
     "display_name": "Иван Гость",
     "room_id": "<room_id>"
   }
   ```
7. Auth-сервис создает запись в `guest_sessions`:
   - `guest_id` (UUID)
   - `expires_at` (created_at + 6 часов)
8. Гость получает временный JWT токен (6 часов)
9. Гость присоединяется к комнате как `anonymous_participant`

**Ограничения гостей:**
- ✅ Полный доступ: микрофон, камера, чат
- ✅ Видят всех участников
- ❌ Не могут создавать комнаты
- ⏱️ Сессия истекает через 6 часов

---

## 🔐 Безопасность

### JWT Токены

**Access Token:**
- Срок жизни: 15 минут
- Используется для всех API запросов
- Хранится в `localStorage`

**Refresh Token:**
- Срок жизни: 7 дней
- Используется для обновления Access Token
- Хранится в `localStorage`
- Поддерживает rotation (старый токен инвалидируется)

**Guest Token:**
- Срок жизни: 6 часов
- Только для присоединения к комнатам
- Не дает права создавать комнаты

### Middleware проверки

VibeMeet использует middleware для проверки JWT:

```go
// internal/middleware/auth_service.go
func AuthServiceMiddleware(authClient *service.AuthServiceClient) gin.HandlerFunc {
    // Проверяет JWT токен от Auth-сервиса
    // Если валиден → пользователь авторизован
    // Если нет → 401 Unauthorized
}
```

---

## 📊 Таблицы БД

### Auth-сервис (localhost:5433)

**users:**
- `id` (UUID) - внешний ID для VibeMeet
- `email` (CITEXT)
- `password_hash` (bcrypt)
- `display_name`
- `is_active`

**guest_sessions:**
- `guest_id` (UUID)
- `display_name`
- `room_id` (TEXT) - ссылка на комнату в VibeMeet
- `expires_at` (TIMESTAMPTZ)
- `ip` (INET)

### VibeMeet (localhost:5432)

**rooms:**
- `id` (UUID)
- `host_user_id` (TEXT) - внешний `user_id` из Auth-сервиса
- `host_email` (TEXT)
- `host_display_name` (TEXT)
- `title`
- `description`

**anonymous_participants:**
- `id` (UUID)
- `room_id` (UUID FK)
- `display_name`
- `participant_id` (TEXT) - `guest_id` из Auth-сервиса
- `joined_at`
- `left_at`

---

## 🎨 UI/UX Изменения

### Главная страница (index.html)

**Было:**
- ❌ "Создать комнату" (без авторизации)
- ❌ "Войти" (по ID комнаты)

**Стало:**
- ✅ "Войти" → Auth.html
- ✅ "Регистрация" → Auth.html#register
- ℹ️ Информационная подсказка о необходимости регистрации

### Dashboard (новая страница)

- Приветствие: "Привет, [Имя]!"
- Кнопка "Выйти"
- "Создать комнату" (основное действие)
- "Войти по ID" (дополнительное действие)

### FAQ обновлен

- Обновлен вопрос "Нужна ли регистрация?"
- Добавлена информация о гостевом доступе

---

## 🧪 Тестирование

### Тестовые пользователи

Созданы через Auth-сервис:

```bash
# Пользователь 1
Email: quickstart@test.com
Password: Quick123!@#

# Пользователь 2
Email: user@test.com
Password: Test123!@#

# Админ
Email: admin@test.com
Password: Admin123!@#
```

### Сценарии тестирования

1. **Регистрация нового пользователя**
   - Открыть http://localhost
   - Нажать "Регистрация"
   - Заполнить форму
   - Проверить редирект на Dashboard

2. **Вход существующего пользователя**
   - Открыть http://localhost
   - Нажать "Войти"
   - Ввести credentials
   - Проверить редирект на Dashboard

3. **Создание комнаты**
   - Авторизоваться
   - Нажать "Создать комнату"
   - Проверить переход в room.html
   - Проверить LiveKit подключение

4. **Гостевой доступ**
   - Скопировать ссылку на комнату
   - Открыть в режиме инкогнито
   - Ввести имя гостя
   - Проверить присоединение к комнате

5. **Выход из системы**
   - Нажать "Выйти" на Dashboard
   - Проверить очистку localStorage
   - Проверить редирект на главную

---

## 🔄 Миграция со старой версии

Если у вас была старая версия VibeMeet с анонимными комнатами:

1. Примените миграцию:
   ```bash
   cd /Users/ilpaka/Development/vibeemeet
   psql -h localhost -p 5432 -U vibeemeet_user -d vibeemeet_db -f migrations/006_integrate_auth_service.sql
   ```

2. Старые комнаты останутся в БД, но:
   - `host_user_id` будет `NULL` или старый локальный ID
   - Новые комнаты будут использовать внешний `user_id`

3. Рекомендуется очистить старые анонимные комнаты:
   ```sql
   DELETE FROM rooms WHERE host_user_id IS NULL OR host_user_id NOT LIKE '%-%-%-%-%';
   ```

---

## 📝 Примечания

### Автоматический редирект

- Если пользователь авторизован и открывает `index.html` → редирект на `Dashboard.html`
- Если пользователь не авторизован и открывает `Dashboard.html` → редирект на `index.html`

### Обновление токенов

Dashboard.js содержит функцию `refreshAccessToken()` для автоматического обновления токенов при истечении.

### CORS

Auth-сервис настроен на разрешение запросов от:
- `http://localhost` (VibeMeet frontend)
- `http://localhost:8081` (VibeMeet API)

---

## 🎯 Следующие шаги

1. ✅ Интеграция с Auth-сервисом
2. ✅ Новый user flow
3. ✅ Гостевой доступ
4. 🔄 Добавить "Мои комнаты" на Dashboard
5. 🔄 Email верификация
6. 🔄 Восстановление пароля
7. 🔄 OAuth (Google, GitHub)

---

**Документация обновлена:** 2026-01-13
